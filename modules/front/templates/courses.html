{% extends "layout.html" %}

<!-- Course card -->
{% from "components/courses.html" import render_course_card %}

<!-- Content -->
{% block content %}
<h1 class="text-xl font-bold text-center mb-8">Gerenciamento de Cursos na Conta</h1>

{% if is_library %}

<p class="text-center">Alguma coisa relacionado a pesquisas aqui (em desenvolvimento)</p>

{% elif courses %}
<h1 class="text-lg font-bold text-center mb-1">
  <i class="fa-solid fa-cart-arrow-down"></i> Cursos na Conta Inicializada
</h1>

<div class="grid grid-cols-1 gap-4 mx-4">
  <div class="flex items-center justify-center">
    <i class="fas fa-magnifying-glass mr-2"></i>
    <input
      class="input input-bordered input-sm !outline-none w-3/5"
      placeholder="Pesquisar Cursos..."
      id="searchCoursesInput"
    />
  </div>

  {% for course in courses %}
  <!-- Course card -->
  {{ render_course_card(course) }}
  <!-- End of Course card -->
  {% endfor %}
</div>
{% endif %}

<!-- End of Content -->
{% endblock content %}

<!-- Scripts -->
{% block scripts %}
<script>
  const enableCourseNameEditBtns = document.querySelectorAll(
    ".btn-enable-edit-course-name"
  )
  const searchCoursesInput = document.getElementById("searchCoursesInput")

  const courseContentLoaderBtns = document.querySelectorAll(".btn-course-content-loader")

  const modalControllers = document.querySelectorAll(".modal-controller[data-course-id]")

  // esse objeto aqui é quem vai salvar o krl todo
  var coursesToDownload = []

  const courses = document.querySelectorAll(".course-card")
  courses.forEach((course) => {
    coursesToDownload.push({
      id: course.dataset.courseId,
      name: course.querySelector(".course-name").innerText,
      subdomain: course.dataset.courseSubdomain,
      toDownload: true,
      children: [],
    })
  })

  const findPath = (forest, targetId, targetSubdomain, path = []) => {
    for (const tree of forest) {
      if (tree.id === targetId && tree.subdomain === targetSubdomain) {
        return [...path, { id: tree.id, subdomain: tree.subdomain }]
      }

      if (tree.children && tree.children.length > 0) {
        const foundPath = findPath(tree.children, targetId, targetSubdomain, [
          ...path,
          { id: tree.id, subdomain: tree.subdomain },
        ])
        if (foundPath) return foundPath
      }
    }
    return null
  }

  const normalizeName = (name) => {
    return name.replace(/[#@$!%^&*+\-={};':"\\|,.<>\/?]+/g, "")
  }

  const labeledCheckbox = (text) => {
    const div = document.createElement("div")
    div.className = "form-control"

    const label = document.createElement("label")
    label.className = "label cursor-pointer"
    div.appendChild(label)

    const span = document.createElement("span")
    span.className = "label-text"
    span.innerText = text
    label.appendChild(span)

    const checkbox = document.createElement("input")
    checkbox.type = "checkbox"
    checkbox.className = "checkbox checkbox-primary checkbox-sm"
    checkbox.checked = true
    label.appendChild(checkbox)

    return div
  }

  // Filtro pelo Nome do Curso
  searchCoursesInput.addEventListener("input", (event) => {
    const searchTerm = event.target.value.toLowerCase()
    const courseCards = document.querySelectorAll(".course-card")
    courseCards.forEach((card) => {
      const courseName = card.querySelector(".course-name").innerText.toLowerCase()
      card.classList.toggle("hidden", !courseName.includes(searchTerm))
    })
  })

  // Habilitar Edição do Nome do Curso
  const enableCourseNameEdit = (courseId) => {
    const query = `.course-name[data-course-id="${courseId}"]`
    // pega tudo, pq eu imagino isso daqui como um controlador de "estado" da variável "course_name"
    const courseNameTags = document.querySelectorAll(query)
    const courseNameCardTitle = courseNameTags[0]
    const courseName = courseNameCardTitle.innerText

    const btnQuery = `.btn-enable-edit-course-name[data-course-id="${courseId}"]`
    const btn = document.querySelector(btnQuery)
    btn.classList.toggle("btn-disabled")

    const courseNameInput = document.createElement("input")
    courseNameInput.className = "input input-bordered input-sm w-full"
    courseNameInput.value = courseName
    courseNameInput.oninput = (event) =>
      (event.target.value = normalizeName(event.target.value))

    courseNameInput.onkeydown = (event) => {
      // Volta ao estado normal (span)
      if (event.key === "Enter") {
        event.preventDefault()
        courseNameTags.forEach((tag) => {
          tag.innerText = courseNameInput.value
        })
        event.currentTarget.replaceWith(courseNameCardTitle)
        btn.classList.toggle("btn-disabled")

        // atualiza lá no objeto geralzão
        coursesToDownload.map((course) => {
          if (course.id === courseId) {
            course.name = courseNameInput.value
          }
          return course
        })
      }
    }

    courseNameCardTitle.replaceWith(courseNameInput)
  }

  // Adiciona o evento de clique para habilitar a edição do nome do curso
  enableCourseNameEditBtns.forEach((btn) => {
    btn.addEventListener("click", (event) => {
      const courseId = event.target.dataset.courseId
      enableCourseNameEdit(courseId)
    })
  })

  // Adiciona evento de clique para abrir o modal
  modalControllers.forEach((controller) => {
    controller.addEventListener("click", (event) => {
      const courseId = event.target.dataset.courseId
      const modalTrigger = document.querySelector(
        `.modal-toggle[data-course-id="${courseId}"]`
      )
      modalTrigger.checked = !modalTrigger.checked
    })
  })

  const fetchMoreDetails = async (subdomain, itemId, path) => {
    try {
      const res = await fetch("/api/load_course_data", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ club: subdomain, id: itemId, path }),
      })
      const data = await res.json()
      return data
    } catch (e) {
      console.log(e)
    }
  }

  const searchPages = (event, moduleId) => {
    const searchTerm = event.target.value.toLowerCase()
    const lessonCards = document.querySelectorAll(
      `.lesson-card[data-lesson-module-id="${moduleId}"]`
    )
    lessonCards.forEach((card) => {
      const lessonName = card.querySelector(".lesson-title").innerText.toLowerCase()
      card.classList.toggle("hidden", !lessonName.includes(searchTerm))
    })
  }

  const renderLessons = (parentObj, lessons, storage) => {
    var content = []
    lessons.forEach((lesson, index) => {
      storage.push({
        id: lesson.id,
        name: lesson.name,
        subdomain: lesson.subdomain,
        toDownload: true,
        children: [],
      })
      const lessonDiv = document.createElement("div")
      lessonDiv.className = "card w-full bg-base-100 shadow-xl lesson-card"

      const lessonBody = document.createElement("div")
      lessonBody.className = "card-body my-0.5 py-0.5"

      const lessonTitle = document.createElement("h2")
      lessonTitle.className = "card-title lesson-title text-md"
      lessonTitle.innerText = lesson.name
      lessonTitle.setAttribute("data-lesson-module-id", parentObj.id)

      lessonBody.appendChild(lessonTitle)

      const lessonTitleChanger = document.createElement("input")
      lessonTitleChanger.className = "input input-bordered input-sm w-full"
      lessonTitleChanger.value = lesson.name
      lessonTitleChanger.oninput = (event) => {
        event.target.value = normalizeName(event.target.value)
        storage[index].name = event.target.value
      }

      lessonBody.appendChild(lessonTitleChanger)

      const lessonActions = document.createElement("div")
      lessonActions.className = "card-actions justify-end"

      const checkboxToDownload = labeledCheckbox("Marcar para Download")
      checkboxToDownload.querySelector("input").onchange = (event) => {
        storage[index].toDownload = event.target.checked
      }
      lessonActions.appendChild(checkboxToDownload)

      const lessonLoadMoreBtn = document.createElement("button")
      lessonLoadMoreBtn.className = "btn btn-primary btn-sm"
      lessonLoadMoreBtn.innerText = "Carregar mais"

      lessonLoadMoreBtn.onclick = async (event) => {
        event.target.disabled = true
        await loadChildren(
          lesson.subdomain,
          lesson.id,
          lessonBody,
          storage[index].children,
          findPath(coursesToDownload, parentObj.id, parentObj.subdomain)
        )
        event.target.remove()
      }

      lessonActions.appendChild(lessonLoadMoreBtn)
      lessonBody.appendChild(lessonActions)
      lessonDiv.appendChild(lessonBody)

      content.push(lessonDiv)
    })

    return content
  }

  const renderModuleCard = (module, index, storage) => {
    const moduleCard = document.createElement("div")
    moduleCard.className = "card w-full bg-base-200 rounded-box shadow-xl"

    const moduleCardBody = document.createElement("div")
    moduleCardBody.className = "card-body"

    const moduleCardTitle = document.createElement("h2")
    moduleCardTitle.className = "card-title"
    moduleCardTitle.innerText = `Módulo ${index + 1}: ${module.name}`

    moduleCardBody.appendChild(moduleCardTitle)

    const moduleTitleChanger = document.createElement("input")
    moduleTitleChanger.type = "text"
    moduleTitleChanger.className = "input input-bordered input-sm w-full"
    moduleTitleChanger.value = module.name
    moduleTitleChanger.oninput = (event) => {
      event.target.value = normalizeName(event.target.value)
      storage.name = event.target.value
    }

    moduleCardBody.appendChild(moduleTitleChanger)

    const checkboxToDownload = labeledCheckbox("Marcar para Download")
    checkboxToDownload.querySelector("input").onchange = (event) => {
      storage.toDownload = event.target.checked
    }
    moduleCardBody.appendChild(checkboxToDownload)

    const moduleLessonsCollapse = document.createElement("details")
    moduleLessonsCollapse.className = "collapse collapse-plus"

    const lessons = module.pages // isso será lessons depois.

    const lessonsCollapse = document.createElement("summary")
    lessonsCollapse.className = "collapse-title font-medium text-center text-primary my-0"
    lessonsCollapse.innerText = `Conteúdos - ${lessons.length}`

    moduleLessonsCollapse.appendChild(lessonsCollapse)

    const lessonsCollapseContent = document.createElement("div")
    lessonsCollapseContent.className = "collapse-content flex flex-col gap-2 mx-0 px-0"
    lessonsCollapseContent.innerHTML = `
    <input
      type="text"
      class="input input-bordered input-sm w-full"
      placeholder="Pesquisar conteúdo..."
      oninput="searchPages(event, '${module.id}')"
    />
    `
    const lessonsContent = renderLessons(module, lessons, storage["children"])
    lessonsContent.forEach((lesson) => {
      lessonsCollapseContent.appendChild(lesson)
    })

    moduleLessonsCollapse.appendChild(lessonsCollapseContent)

    moduleCardBody.appendChild(moduleLessonsCollapse)

    moduleCard.appendChild(moduleCardBody)

    return moduleCard
  }

  const loadChildren = async (subdomain, itemId, parent, storage, path = []) => {
    const data = await fetchMoreDetails(subdomain, itemId, path)
    // data possui modules, cada module possui pages ablueblue

    data.modules.forEach((module, index) => {
      storage.push({
        id: module.id,
        name: module.name,
        subdomain: subdomain,
        toDownload: true,
        children: [],
      })
      const moduleCard = renderModuleCard(module, index, storage[index])
      parent.appendChild(moduleCard)
    })
  }

  // Adiciona evento de clique para carregar o conteúdo do curso em questão
  courseContentLoaderBtns.forEach((btn) => {
    btn.addEventListener("click", async (event) => {
      const courseId = event.target.dataset.courseId
      const courseSubdomain = event.target.dataset.courseSubdomain
      event.target.disabled = true

      const courseContent = document.querySelector(
        `.course-content[data-course-id="${courseId}"]`
      )
      var childrenList = coursesToDownload.find((course) => course.id === courseId)[
        "children"
      ]

      await loadChildren(courseSubdomain, courseId, courseContent, childrenList)

      event.target.remove()
    })
  })

  // Adiciona evento de marcar curso para download ou não.
  coursesToDownload.forEach((course) => {
    const checkbox = document.querySelector(
      `.checkbox-download-course[data-course-id="${course.id}"]`
    )

    checkbox.onchange = (event) => {
      course.toDownload = event.target.checked
    }
  })
</script>
{% endblock scripts %}
